<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zagreb Bibliobus - Schedule</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- Add to Calendar Button library (using a newer version that's more reliable) -->
    <script src="https://cdn.jsdelivr.net/npm/add-to-calendar-button@2.4.1/dist/atcb.min.js" async defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/add-to-calendar-button@2.4.1/dist/atcb.min.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="language-selector">
                <a href="index.html" class="language-link" data-lang="hr">HR</a>
                <span class="language-separator">|</span>
                <a href="index-en.html" class="language-link active" data-lang="en">EN</a>
            </div>
            <h1><i class="fas fa-bus"></i> Zagreb Bibliobus</h1>
            <p>Mobile Library Schedule</p>
            <div class="updated">Updated: {{LAST_UPDATED}}</div>
        </div>
    </header>

    <main class="container">
        <div class="navigation-container">
            <div class="data-views">
                <div class="data-tab active" data-tab="table">List by date</div>
                <div class="data-tab" data-tab="calendar">Calendar view</div>
            </div>
            
            <div class="location-tabs-wrapper">
                <div class="location-tabs" id="location-tabs">
                    <div class="location-tab active" data-location-id="">All locations</div>
                    <!-- Location tabs will be populated from JSON data -->
                </div>
                <div class="location-tabs-scroll">
                    <button class="scroll-btn scroll-left" aria-label="Scroll left"><i class="fas fa-chevron-left"></i></button>
                    <button class="scroll-btn scroll-right" aria-label="Scroll right"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            
            <div class="data-download">
                <a href="bibliobus-data.json" download><i class="fas fa-download"></i> Download JSON</a>
                <a id="calendar-download" href="bibliobus-calendar.ics" download>
                    <i class="fas fa-calendar-alt"></i> <span id="calendar-download-text">Download iCalendar (all locations)</span>
                </a>
            </div>
        </div>

        <div id="table-view" class="data-view active">
            <div id="list-view-container">
                <!-- List data will be inserted here via JavaScript -->
            </div>
        </div>

        <div id="calendar-view" class="data-view">
            <div class="calendar-nav">
                <button id="prev-month">&laquo; Previous month</button>
                <h2 id="current-month">April 2025</h2>
                <button id="next-month">Next month &raquo;</button>
            </div>
            <div class="calendar-info">
                <div class="calendar-actions">
                    <div class="calendar-download">
                        <p>Download calendar file:</p>
                        <a id="calendar-info-link" href="bibliobus-calendar.ics" download class="calendar-download-btn">
                            <i class="fas fa-download"></i> Download iCalendar
                        </a>
                    </div>
                    
                    <div class="calendar-widget">
                        <p>Add directly to your calendar:</p>
                        <div id="add-to-calendar-widget"></div>
                    </div>
                </div>
                
                <p class="location-specific-note"><strong>Important:</strong> When you select a location above (e.g. "KAJZERICA"), 
                the calendar file and widget will contain data <strong>only for the selected location</strong>.</p>
            </div>
            <div id="calendar-container">
                <!-- Calendar will be rendered here -->
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Zagreb Bibliobus - Generated using <a href="https://github.com/allixsenos/ZgBibliobusTimeTable">ZgBibliobusTimeTable</a></p>
        </div>
    </footer>

    <script>
        // Data loaded from JSON file
        const data = {{JSON_DATA}};
        const scheduleData = data.sessions;
        const locationOptions = data.locations;
        
        // Function to convert ISO date (yyyy-MM-dd) to English date (MM/dd/yyyy)
        function isoToEnglishDate(isoDate) {
            if (!isoDate) return '';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            return `${parts[1]}/${parts[2]}/${parts[0]}`;
        }
        
        // Function to convert English date (MM/dd/yyyy) to ISO date (yyyy-MM-dd)
        function englishToIsoDate(englishDate) {
            if (!englishDate) return '';
            const parts = englishDate.split('/');
            if (parts.length < 3) return englishDate;
            return `${parts[2]}-${parts[0]}-${parts[1]}`;
        }
        
        // Function to normalize time for proper sorting
        function normalizeTimeForSorting(timeStr) {
            if (!timeStr) return '';
            
            // First extract text content if HTML is present
            let cleanTime = timeStr;
            if (timeStr.includes('<') && timeStr.includes('>')) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = timeStr;
                cleanTime = tempDiv.textContent.trim();
            }
            
            // Extract first time if it's a range
            if (cleanTime.includes('-')) {
                cleanTime = cleanTime.split('-')[0].trim();
            }
            
            // Normalize format to ensure double-digit hours
            if (cleanTime.match(/^\d:\d\d$/)) {
                cleanTime = '0' + cleanTime; // Add leading zero
            }
            
            return cleanTime;
        }
        
        // Function to compare two times for sorting
        function compareTimeStrings(timeA, timeB) {
            const normalizedA = normalizeTimeForSorting(timeA);
            const normalizedB = normalizeTimeForSorting(timeB);
            
            return normalizedA.localeCompare(normalizedB);
        }
        
        // Function to translate day names to English
        function translateDayName(croatianDay) {
            const dayTranslations = {
                'ponedjeljak': 'Monday',
                'utorak': 'Tuesday',
                'srijeda': 'Wednesday',
                'Äetvrtak': 'Thursday',
                'petak': 'Friday',
                'subota': 'Saturday',
                'nedjelja': 'Sunday'
            };
            
            return dayTranslations[croatianDay.toLowerCase()] || croatianDay;
        }
        
        // Initialize location tabs
        const locationTabsContainer = document.getElementById('location-tabs');
        
        // Debug location options
        console.log("All location options:", locationOptions);
        
        // Add location options to the tabs (first one "All locations" is already there)
        locationOptions.slice(1).forEach(location => {
            const tab = document.createElement('div');
            tab.className = 'location-tab';
            tab.textContent = location.name;
            tab.dataset.locationId = location.value;
            tab.dataset.calendarFile = location.calendarFile;
            locationTabsContainer.appendChild(tab);
            
            console.log(`Added location tab: name=${location.name}, id=${location.value}, calendar=${location.calendarFile}`);
        });
        
        // Make sure the "All locations" tab has the correct data attributes
        const allLocationsTab = locationTabsContainer.querySelector('.location-tab.active');
        allLocationsTab.dataset.calendarFile = "bibliobus-calendar.ics";
        
        // Add click events to location tabs
        document.querySelectorAll('.location-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                document.querySelectorAll('.location-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const locationId = tab.dataset.locationId;
                const calendarFile = tab.dataset.calendarFile;
                const locationName = tab.textContent;
                const isAllLocations = locationId === '';
                
                console.log(`Selected location: name=${locationName}, id=${locationId}, isAllLocations=${isAllLocations}`);
                
                // Update download links
                document.getElementById('calendar-download').href = calendarFile;
                document.getElementById('calendar-info-link').href = calendarFile;
                
                // Update download text
                const downloadTextElement = document.getElementById('calendar-download-text');
                if (isAllLocations) {
                    downloadTextElement.textContent = 'Download iCalendar (all locations)';
                } else {
                    downloadTextElement.textContent = `Download iCalendar (${locationName})`;
                }
                
                // Debug the location filter and session data
                console.log(`Filtering data by location ID: ${locationId}`);
                console.log(`Data contains ${scheduleData.length} total sessions`);
                
                // Sample session data to check structure
                if (scheduleData.length > 0) {
                    console.log('Sample session data:', scheduleData[0]);
                    
                    // Check all available locationId values in the data
                    const allLocationIds = [...new Set(scheduleData.map(s => s.locationId))];
                    console.log('All location IDs in data:', allLocationIds);
                }
                
                // Update the Add to Calendar Widget
                updateAddToCalendarWidget(locationName, isAllLocations, calendarFile);
                
                // Update calendar and table views
                filterScheduleByLocation(locationId);
                if (calendarInitialized) {
                    renderCalendar(currentDate);
                }
            });
        });
        
        // Add horizontal scrolling for location tabs
        const tabsContainer = document.querySelector('.location-tabs');
        const scrollLeftBtn = document.querySelector('.scroll-left');
        const scrollRightBtn = document.querySelector('.scroll-right');
        
        scrollLeftBtn.addEventListener('click', () => {
            tabsContainer.scrollBy({ left: -200, behavior: 'smooth' });
        });
        
        scrollRightBtn.addEventListener('click', () => {
            tabsContainer.scrollBy({ left: 200, behavior: 'smooth' });
        });
        
        // Check if scrolling is needed and show/hide scroll buttons accordingly
        function updateScrollButtons() {
            const hasHorizontalScroll = tabsContainer.scrollWidth > tabsContainer.clientWidth;
            const scrollContainer = document.querySelector('.location-tabs-scroll');
            scrollContainer.style.display = hasHorizontalScroll ? 'flex' : 'none';
        }
        
        // Update on load and on window resize
        window.addEventListener('load', updateScrollButtons);
        window.addEventListener('resize', updateScrollButtons);
        
        // Generate list view from the schedule data
        function generateListView() {
            const container = document.getElementById('list-view-container');
            container.innerHTML = ''; // Clear previous content
            
            // Get the current location filter
            const activeTab = document.querySelector('.location-tab.active');
            const locationFilter = activeTab ? activeTab.dataset.locationId : '';
            
            console.log(`Generating list view with location filter: ${locationFilter}`);
            
            // Group sessions by date
            const sessionsByDate = {};
            
            // Filter sessions based on location
            const filteredSessions = scheduleData.filter(session => {
                const isNonWorkingDay = session.isNeradniDan;
                return locationFilter === '' || 
                    session.locationId === locationFilter || 
                    (locationFilter === '' && isNonWorkingDay);
            });
            
            // Group by date
            filteredSessions.forEach(session => {
                if (!sessionsByDate[session.datum]) {
                    sessionsByDate[session.datum] = [];
                }
                sessionsByDate[session.datum].push(session);
            });
            
            console.log(`Grouped into ${Object.keys(sessionsByDate).length} dates`);
            
            // Sort dates chronologically
            const sortedDates = Object.keys(sessionsByDate).sort();
            
            // Determine which dates are in the past and which are future
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to start of today
            
            // Create a date for one week ago
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const futureDates = [];
            const recentPastDates = []; // Dates from the last week
            const olderPastDates = []; // Dates older than one week
            
            sortedDates.forEach(dateString => {
                const dateParts = dateString.split('-');
                const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); // Months are 0-indexed
                
                if (date >= today) {
                    futureDates.push(dateString);
                } else if (date >= oneWeekAgo) {
                    recentPastDates.push(dateString);
                } else {
                    olderPastDates.push(dateString);
                }
            });
            
            // Sort recent past dates in reverse chronological order (newest first)
            recentPastDates.sort((a, b) => b.localeCompare(a));
            
            console.log(`Found ${futureDates.length} future dates, ${recentPastDates.length} recent past dates (last week), and ${olderPastDates.length} older past dates`);
            
            // If there are older past dates, add a button to show them
            if (olderPastDates.length > 0) {
                const showPastButton = document.createElement('button');
                showPastButton.className = 'past-dates-button';
                showPastButton.textContent = 'Show older schedule';
                showPastButton.addEventListener('click', function() {
                    const listContainer = document.getElementById('list-view-container');
                    listContainer.classList.toggle('show-past-dates');
                    this.textContent = listContainer.classList.contains('show-past-dates') 
                        ? 'Hide older schedule' 
                        : 'Show older schedule';
                });
                container.appendChild(showPastButton);
            }
            
            // Function to create date section - reused for both future and past dates
            function createDateSection(date, isPastDate = false) {
                const sessions = sessionsByDate[date];
                const isNonWorking = sessions.some(s => s.isNeradniDan);
                
                // Get day name from the first session and translate to English
                const dayName = sessions.length > 0 ? translateDayName(sessions[0].dan) : '';
                
                // Create date heading
                const heading = document.createElement('h2');
                heading.className = isPastDate ? 'date-heading past-date-heading' : 'date-heading';
                
                // Convert ISO date to English format
                const englishDate = isoToEnglishDate(date);
                
                heading.innerHTML = `${englishDate} <span class="day-name">${dayName}</span>`;
                container.appendChild(heading);
                
                // Create entries container
                const entriesDiv = document.createElement('div');
                entriesDiv.className = isPastDate ? 'schedule-entries past-schedule-entries' : 'schedule-entries';
                
                if (isNonWorking) {
                    // Non-working day
                    const entry = document.createElement('div');
                    entry.className = 'schedule-entry non-working-date';
                    entry.innerHTML = '<div class="schedule-entry-time"></div><div class="schedule-entry-location">Non-working day</div>';
                    entriesDiv.appendChild(entry);
                } else {
                    // Sort sessions by time using our custom time sorting function
                    sessions.sort((a, b) => compareTimeStrings(a.vrijeme, b.vrijeme));
                    
                    // Add each session
                    sessions.forEach(session => {
                        const entry = document.createElement('div');
                        entry.className = 'schedule-entry';
                        
                        // Create time element
                        const timeDiv = document.createElement('div');
                        timeDiv.className = 'schedule-entry-time';
                        
                        // Handle raw HTML in time field and normalize
                        let timeText = "";
                        
                        if (session.vrijeme.includes('<') && session.vrijeme.includes('>')) {
                            // Extract text content from HTML 
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = session.vrijeme;
                            timeText = tempDiv.textContent.trim();
                        } else {
                            timeText = session.vrijeme;
                        }
                        
                        // Ensure consistent display with leading zeros and standardized dash format
                        if (timeText.includes('-')) {
                            // Standardize the dash format to always be " - " with spaces
                            let parts = timeText.split('-').map(part => part.trim());
                            let startTime = parts[0];
                            let endTime = parts[1];
                            
                            // Add leading zero if needed
                            if (startTime.match(/^\d:\d\d/)) {
                                startTime = '0' + startTime;
                            }
                            
                            // Add leading zero to end time if needed
                            if (endTime.match(/^\d:\d\d/)) {
                                endTime = '0' + endTime;
                            }
                            
                            // Always use standardized format with spaces around dash
                            timeText = `${startTime} - ${endTime}`;
                        } else if (timeText.match(/^\d:\d\d/)) {
                            // Just a single time without range
                            timeText = '0' + timeText;
                        }
                        
                        timeDiv.textContent = timeText;
                        
                        // Create location element with possible link
                        const locationDiv = document.createElement('div');
                        locationDiv.className = 'schedule-entry-location';
                        
                        // Get clean location text
                        let locationText = session.lokacija;
                        if (locationText.includes('<') && locationText.includes('>')) {
                            // Extract text content from HTML
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = locationText;
                            locationText = tempDiv.textContent.trim();
                        }
                        
                        if (session.mapUrl) {
                            const link = document.createElement('a');
                            link.href = session.mapUrl;
                            link.className = 'location-link';
                            link.textContent = locationText;
                            link.target = '_blank';
                            link.title = session.address || locationText;
                            locationDiv.appendChild(link);
                        } else {
                            locationDiv.textContent = locationText;
                        }
                        
                        // Add time and location to entry
                        entry.appendChild(timeDiv);
                        entry.appendChild(locationDiv);
                        
                        // Add entry to container
                        entriesDiv.appendChild(entry);
                    });
                }
                
                container.appendChild(entriesDiv);
            }
            
            // First display recent past dates (from the last week)
            if (recentPastDates.length > 0) {
                const recentPastHeader = document.createElement('h2');
                recentPastHeader.className = 'list-section-header';
                recentPastHeader.textContent = 'Recent dates (last 7 days)';
                container.appendChild(recentPastHeader);
                
                recentPastDates.forEach(date => createDateSection(date, false));
            }
            
            // Then display future dates
            if (futureDates.length > 0) {
                const futureHeader = document.createElement('h2');
                futureHeader.className = 'list-section-header';
                futureHeader.textContent = 'Upcoming dates';
                container.appendChild(futureHeader);
                
                futureDates.forEach(date => createDateSection(date, false));
            }
            
            // Add older past dates (initially hidden)
            if (olderPastDates.length > 0) {
                olderPastDates.forEach(date => createDateSection(date, true));
            }
            
            // If no entries at all, show appropriate message
            if (sortedDates.length === 0) {
                const noData = document.createElement('p');
                noData.className = 'no-data-message';
                noData.textContent = 'No data for the selected location.';
                container.appendChild(noData);
            } else if (futureDates.length === 0 && recentPastDates.length === 0) {
                // If there are no future or recent dates, but there might be older dates
                const noData = document.createElement('p');
                noData.className = 'no-data-message';
                noData.textContent = 'No future or recent dates for the selected location.';
                
                // Insert this message before the past dates button if it exists
                const pastButton = container.querySelector('.past-dates-button');
                if (pastButton) {
                    container.insertBefore(noData, pastButton);
                } else {
                    container.appendChild(noData);
                }
            }
        }
        
        // Filter functionality based on location
        function filterScheduleByLocation(locationId) {
            // Generate the list view with the new filter
            generateListView();
        }
        
        // Tab switching
        document.querySelectorAll('.data-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding view
                document.querySelectorAll('.data-view').forEach(view => view.classList.remove('active'));
                document.getElementById(tab.dataset.tab + '-view').classList.add('active');
                
                // Update URL with view parameter
                const url = new URL(window.location);
                url.searchParams.set('view', tab.dataset.tab);
                window.history.pushState({}, '', url);
                
                // If switching to calendar, initialize it
                if (tab.dataset.tab === 'calendar') {
                    initCalendar();
                }
            });
        });
        
        // Calendar functionality
        let currentDate = new Date();
        let calendarInitialized = false;
        
        function initCalendar() {
            if (!calendarInitialized) {
                renderCalendar(currentDate);
                
                document.getElementById('prev-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar(currentDate);
                });
                
                document.getElementById('next-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar(currentDate);
                });
                
                calendarInitialized = true;
            }
        }
        
        function renderCalendar(date) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            const year = date.getFullYear();
            const month = date.getMonth();
            const activeTab = document.querySelector('.location-tab.active');
            const locationFilter = activeTab ? activeTab.dataset.locationId : '';
            
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let calendarHTML = '<div class="calendar">';
            calendarHTML += '<div class="calendar-header">';
            calendarHTML += '<div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>';
            calendarHTML += '</div>';
            calendarHTML += '<div class="calendar-body">';
            
            // Fill in leading empty cells
            let dayOfWeek = firstDay.getDay() || 7; // Convert Sunday (0) to 7
            for (let i = 1; i < dayOfWeek; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }
            
            // Fill in days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDay = new Date(year, month, day);
                const isoDateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const englishDateString = `${month + 1}/${day}/${year}`;
                
                // Check if this day is in the past
                const calendarDate = new Date(year, month, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isPastDate = calendarDate < today;
                
                // Find schedule entries for this day, filtered by selected location if any
                let dayEntries = scheduleData.filter(entry => entry.datum === isoDateString);
                
                // Apply location filter if set
                if (locationFilter) {
                    // Debug the filtering process
                    console.log('Filtering by location ID:', locationFilter);
                    console.log('Before filter, entries:', dayEntries.length);
                    
                    dayEntries = dayEntries.filter(entry => {
                        const matches = entry.locationId === locationFilter || entry.isNeradniDan;
                        console.log(`Entry locationId: ${entry.locationId}, matches filter: ${matches}`);
                        return matches;
                    });
                    
                    console.log('After filter, entries:', dayEntries.length);
                }
                
                let dayClass = 'calendar-day';
                if (dayEntries.length > 0) {
                    dayClass += ' has-events';
                }
                if (isPastDate) {
                    dayClass += ' past-date';
                }
                
                calendarHTML += `<div class="${dayClass}" data-date="${englishDateString}">`;
                calendarHTML += `<div class="day-number">${day}</div>`;
                
                if (dayEntries.length > 0) {
                    calendarHTML += '<div class="day-events">';
                    
                    // Group entries by location for this day
                    const entriesByLocation = {};
                    dayEntries.forEach(entry => {
                        if (!entriesByLocation[entry.lokacija]) {
                            entriesByLocation[entry.lokacija] = [];
                        }
                        entriesByLocation[entry.lokacija].push(entry);
                    });
                    
                    // Display all locations directly, always visible
                    const locations = Object.keys(entriesByLocation).sort();
                    
                    // For non-working days, display specially
                    if (locations.includes("=== neradni dan ===")) {
                        calendarHTML += `<div class="calendar-location non-working-day">Non-working day</div>`;
                    } else {
                        // Create a sorted list of entries by start time
                        let allEntries = [];
                        
                        console.log(`Day has ${locations.length} locations:`, locations);
                        
                        locations.forEach(location => {
                            console.log(`Processing location: ${location}, has ${entriesByLocation[location].length} entries`);
                            
                            entriesByLocation[location].forEach(entry => {
                                // Extract and normalize the start time from the time range
                                let startTime = "";
                                let rawTime = entry.vrijeme;
                                
                                // Handle HTML in time
                                if (rawTime && rawTime.includes('<') && rawTime.includes('>')) {
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = rawTime;
                                    rawTime = tempDiv.textContent.trim();
                                }
                                
                                // Extract start time from range
                                if (rawTime && rawTime.includes('-')) {
                                    startTime = rawTime.split('-')[0].trim();
                                } else if (rawTime) {
                                    startTime = rawTime;
                                }
                                
                                console.log(`Entry time: ${entry.vrijeme}, start time: ${startTime}, location: ${entry.lokacija}`);
                                
                                if (startTime) {
                                    allEntries.push({
                                        startTime: startTime,
                                        location: entry.lokacija,
                                        fullTime: entry.vrijeme
                                    });
                                }
                            });
                        });
                        
                        // Sort entries by start time using our custom time sorting function
                        allEntries.sort((a, b) => compareTimeStrings(a.startTime, b.startTime));
                        
                        // Display all entries in time-first format with map links
                        allEntries.forEach(entry => {
                            // Look up location data from the locations array instead of sessions
                            // This way we get consistent map URLs for locations regardless of date/time
                            const locationData = data.locations.find(loc => loc.name === entry.location);
                            
                            // Make sure the time is padded with a leading zero if needed for consistency
                            let displayTime = entry.startTime;
                            if (displayTime.match(/^\d:\d\d$/)) {
                                displayTime = '0' + displayTime;
                            }
                            
                            // Add debug info
                            console.log(`Building entry HTML: time=${displayTime}, location="${entry.location}", hasMap=${locationData && locationData.mapUrl ? 'true' : 'false'}`);
                            
                            // Ultra simplified calendar entry - just time and location as a single item
                            if (locationData && locationData.mapUrl) {
                                // Create entry as a link to the map
                                calendarHTML += `<div class="calendar-location">
                                    <a href="${locationData.mapUrl}" target="_blank" class="location-entry-link" 
                                        title="${locationData.address || locationData.name}">
                                        ${displayTime} ${entry.location}
                                    </a>
                                </div>`;
                            } else {
                                // No map link, just display the plain text
                                calendarHTML += `<div class="calendar-location">
                                    ${displayTime} ${entry.location}
                                </div>`;
                            }
                        });
                    }
                    
                    calendarHTML += '</div>'; // Close day-events
                }
                
                calendarHTML += '</div>';
                
                // Start a new row when reaching Sunday
                if ((dayOfWeek + day - 1) % 7 === 0) {
                    calendarHTML += '</div><div class="calendar-body">';
                }
            }
            
            // Fill in trailing empty cells
            const remainingCells = 7 - (lastDay.getDay() || 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    calendarHTML += '<div class="calendar-day empty"></div>';
                }
            }
            
            calendarHTML += '</div></div>';
            
            document.getElementById('calendar-container').innerHTML = calendarHTML;
        }
        
        // Function to update the Add to Calendar Button widget
        function updateAddToCalendarWidget(locationName, isAllLocations, calendarFile) {
            const widgetContainer = document.getElementById('add-to-calendar-widget');
            if (!widgetContainer) return;
            
            // Clear previous widget
            widgetContainer.innerHTML = '';
            
            // Get the current date in ISO format for the widget start date
            const today = new Date();
            const startDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Create a date 3 months from now for end date
            const endDate = new Date(today);
            endDate.setMonth(today.getMonth() + 3);
            const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
            
            // Using a simplified approach using direct initialization 
            
            // Set widget properties
            const widgetTitle = isAllLocations ? 'Zagreb Bibliobus - Schedule' : `Zagreb Bibliobus - ${locationName}`;
            const widgetDescription = isAllLocations 
                ? 'Schedule of Zagreb mobile library' 
                : `Zagreb mobile library schedule for ${locationName}`;
                
            // Use absolute URL for iCal file (assume we're on the same domain)
            const host = window.location.origin;
            const calPath = calendarFile || 'bibliobus-calendar.ics';
            
            // Create add-to-calendar button using the newer API
            const atcbElement = document.createElement('div');
            atcbElement.className = 'atcb';
            atcbElement.style.display = 'none';
            
            const configProps = {
                name: widgetTitle,
                description: widgetDescription,
                startDate: startDate,
                endDate: endDateStr,
                options: ['Apple', 'Google', 'iCal', 'Microsoft365', 'Outlook.com', 'Yahoo'],
                timeZone: 'Europe/Zagreb',
                iCalFileName: calPath.split('/').pop(),
                listStyle: 'dropdown',
                buttonStyle: 'round',
                label: 'Add to calendar',
                language: 'en',
                ical: `${host}/${calPath}`
            };
            
            // Convert config to JSON string and add as data attribute
            atcbElement.setAttribute('data-config', JSON.stringify(configProps));
            
            // Append to container
            widgetContainer.appendChild(atcbElement);
            
            // Manually initialize if the library is loaded
            if (typeof atcb_init === 'function') {
                setTimeout(() => {
                    atcb_init();
                }, 100);
            }
        }
        
        // Initialize views when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Generate list view immediately
            generateListView();
            
            // Check URL parameters to restore the active view
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view');
            
            if (viewParam && ['table', 'calendar'].includes(viewParam)) {
                // Activate the corresponding tab
                document.querySelectorAll('.data-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === viewParam);
                });
                
                // Show the corresponding view
                document.querySelectorAll('.data-view').forEach(view => {
                    const viewId = view.id;
                    const isMatch = viewId === `${viewParam}-view`;
                    view.classList.toggle('active', isMatch);
                });
                
                // Initialize calendar if needed
                if (viewParam === 'calendar') {
                    initCalendar();
                }
            } else {
                // Auto-initialize calendar if that tab is active (default behavior)
                if (document.querySelector('.data-tab[data-tab="calendar"]').classList.contains('active')) {
                    initCalendar();
                }
            }
            
            // Initialize the Add to Calendar widget
            const activeTab = document.querySelector('.location-tab.active');
            const locationName = activeTab ? activeTab.textContent : 'All locations';
            const isAllLocations = !activeTab || activeTab.dataset.locationId === '';
            const calendarFile = activeTab ? activeTab.dataset.calendarFile : 'bibliobus-calendar.ics';
            
            // Let the page load first, then initialize the widget
            setTimeout(() => {
                updateAddToCalendarWidget(locationName, isAllLocations, calendarFile);
            }, 500);
        });
    </script>
</body>
</html>