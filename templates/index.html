<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zagreb Bibliobus - Raspored</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- Add to Calendar Button library (using stable version 1.5.5) -->
    <script src="https://cdn.jsdelivr.net/npm/add-to-calendar-button@1.5.5/dist/atcb.min.js" async defer></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/add-to-calendar-button@1.5.5/dist/atcb.min.css">
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-bus"></i> Zagreb Bibliobus</h1>
            <p>Raspored bibliobusnih stajališta</p>
            <div class="updated">Ažurirano: {{LAST_UPDATED}}</div>
        </div>
    </header>

    <main class="container">
        <div class="navigation-container">
            <div class="data-views">
                <div class="data-tab active" data-tab="table">Popis po datumima</div>
                <div class="data-tab" data-tab="calendar">Kalendarski prikaz</div>
            </div>
            
            <div class="location-tabs-wrapper">
                <div class="location-tabs" id="location-tabs">
                    <div class="location-tab active" data-location-id="">Sve lokacije</div>
                    <!-- Location tabs will be populated from JSON data -->
                </div>
                <div class="location-tabs-scroll">
                    <button class="scroll-btn scroll-left" aria-label="Scroll left"><i class="fas fa-chevron-left"></i></button>
                    <button class="scroll-btn scroll-right" aria-label="Scroll right"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            
            <div class="data-download">
                <a href="bibliobus-data.json" download><i class="fas fa-download"></i> Preuzmi JSON</a>
                <a id="calendar-download" href="bibliobus-calendar.ics" download>
                    <i class="fas fa-calendar-alt"></i> <span id="calendar-download-text">Preuzmi iCalendar (sve lokacije)</span>
                </a>
            </div>
        </div>

        <div id="table-view" class="data-view active">
            <div id="list-view-container">
                <!-- List data will be inserted here via JavaScript -->
            </div>
        </div>

        <div id="calendar-view" class="data-view">
            <div class="calendar-nav">
                <button id="prev-month">&laquo; Prethodni mjesec</button>
                <h2 id="current-month">Travanj 2025</h2>
                <button id="next-month">Sljedeći mjesec &raquo;</button>
            </div>
            <div class="calendar-info">
                <div class="calendar-actions">
                    <div class="calendar-download">
                        <p>Preuzimanje kalendarske datoteke:</p>
                        <a id="calendar-info-link" href="bibliobus-calendar.ics" download class="calendar-download-btn">
                            <i class="fas fa-download"></i> Preuzmi iCalendar
                        </a>
                    </div>
                    
                    <div class="calendar-widget">
                        <p>Direktno dodavanje u kalendar:</p>
                        <div id="add-to-calendar-widget"></div>
                    </div>
                </div>
                
                <p class="location-specific-note"><strong>Važno:</strong> Kada odaberete lokaciju iznad (npr. "KAJZERICA"), 
                kalendarska datoteka i widget će sadržavati podatke <strong>samo za odabranu lokaciju</strong>.</p>
            </div>
            <div id="calendar-container">
                <!-- Calendar will be rendered here -->
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Zagreb Bibliobus - Generirano pomoću <a href="https://github.com/allixsenos/ZgBibliobusTimeTable">ZgBibliobusTimeTable</a></p>
        </div>
    </footer>

    <script>
        // Data loaded from JSON file
        const data = {{JSON_DATA}};
        const scheduleData = data.sessions;
        const locationOptions = data.locations;
        
        // Function to convert ISO date (yyyy-MM-dd) to Croatian date (dd.MM.yyyy.)
        function isoToCroatianDate(isoDate) {
            if (!isoDate) return '';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            return `${parts[2]}.${parts[1]}.${parts[0]}.`;
        }
        
        // Function to convert Croatian date (dd.MM.yyyy.) to ISO date (yyyy-MM-dd)
        function croatianToIsoDate(croatianDate) {
            if (!croatianDate) return '';
            // Remove trailing dot if present
            const cleanDate = croatianDate.endsWith('.') ? croatianDate.slice(0, -1) : croatianDate;
            const parts = cleanDate.split('.');
            if (parts.length < 3) return croatianDate;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        // Initialize location tabs
        const locationTabsContainer = document.getElementById('location-tabs');
        
        // Debug location options
        console.log("All location options:", locationOptions);
        
        // Add location options to the tabs (first one "Sve lokacije" is already there)
        locationOptions.slice(1).forEach(location => {
            const tab = document.createElement('div');
            tab.className = 'location-tab';
            tab.textContent = location.name;
            tab.dataset.locationId = location.value;
            tab.dataset.calendarFile = location.calendarFile;
            locationTabsContainer.appendChild(tab);
            
            console.log(`Added location tab: name=${location.name}, id=${location.value}, calendar=${location.calendarFile}`);
        });
        
        // Make sure the "All locations" tab has the correct data attributes
        const allLocationsTab = locationTabsContainer.querySelector('.location-tab.active');
        allLocationsTab.dataset.calendarFile = "bibliobus-calendar.ics";
        
        // Add click events to location tabs
        document.querySelectorAll('.location-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                document.querySelectorAll('.location-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const locationId = tab.dataset.locationId;
                const calendarFile = tab.dataset.calendarFile;
                const locationName = tab.textContent;
                const isAllLocations = locationId === '';
                
                console.log(`Selected location: name=${locationName}, id=${locationId}, isAllLocations=${isAllLocations}`);
                
                // Update download links
                document.getElementById('calendar-download').href = calendarFile;
                document.getElementById('calendar-info-link').href = calendarFile;
                
                // Update download text
                const downloadTextElement = document.getElementById('calendar-download-text');
                if (isAllLocations) {
                    downloadTextElement.textContent = 'Preuzmi iCalendar (sve lokacije)';
                } else {
                    downloadTextElement.textContent = `Preuzmi iCalendar (${locationName})`;
                }
                
                // Debug the location filter and session data
                console.log(`Filtering data by location ID: ${locationId}`);
                console.log(`Data contains ${scheduleData.length} total sessions`);
                
                // Sample session data to check structure
                if (scheduleData.length > 0) {
                    console.log('Sample session data:', scheduleData[0]);
                    
                    // Check all available locationId values in the data
                    const allLocationIds = [...new Set(scheduleData.map(s => s.locationId))];
                    console.log('All location IDs in data:', allLocationIds);
                }
                
                // Update the Add to Calendar Widget
                updateAddToCalendarWidget(locationName, isAllLocations, calendarFile);
                
                // Update calendar and table views
                filterScheduleByLocation(locationId);
                if (calendarInitialized) {
                    renderCalendar(currentDate);
                }
            });
        });
        
        // Add horizontal scrolling for location tabs
        const tabsContainer = document.querySelector('.location-tabs');
        const scrollLeftBtn = document.querySelector('.scroll-left');
        const scrollRightBtn = document.querySelector('.scroll-right');
        
        scrollLeftBtn.addEventListener('click', () => {
            tabsContainer.scrollBy({ left: -200, behavior: 'smooth' });
        });
        
        scrollRightBtn.addEventListener('click', () => {
            tabsContainer.scrollBy({ left: 200, behavior: 'smooth' });
        });
        
        // Check if scrolling is needed and show/hide scroll buttons accordingly
        function updateScrollButtons() {
            const hasHorizontalScroll = tabsContainer.scrollWidth > tabsContainer.clientWidth;
            const scrollContainer = document.querySelector('.location-tabs-scroll');
            scrollContainer.style.display = hasHorizontalScroll ? 'flex' : 'none';
        }
        
        // Update on load and on window resize
        window.addEventListener('load', updateScrollButtons);
        window.addEventListener('resize', updateScrollButtons);
        
        // Generate list view from the schedule data
        function generateListView() {
            const container = document.getElementById('list-view-container');
            container.innerHTML = ''; // Clear previous content
            
            // Get the current location filter
            const activeTab = document.querySelector('.location-tab.active');
            const locationFilter = activeTab ? activeTab.dataset.locationId : '';
            
            console.log(`Generating list view with location filter: ${locationFilter}`);
            
            // Group sessions by date
            const sessionsByDate = {};
            
            // Filter sessions based on location
            const filteredSessions = scheduleData.filter(session => {
                const isNonWorkingDay = session.isNeradniDan;
                return locationFilter === '' || 
                    session.locationId === locationFilter || 
                    (locationFilter === '' && isNonWorkingDay);
            });
            
            // Group by date
            filteredSessions.forEach(session => {
                if (!sessionsByDate[session.datum]) {
                    sessionsByDate[session.datum] = [];
                }
                sessionsByDate[session.datum].push(session);
            });
            
            console.log(`Grouped into ${Object.keys(sessionsByDate).length} dates`);
            
            // Sort dates chronologically
            const sortedDates = Object.keys(sessionsByDate).sort();
            
            // Determine which dates are in the past
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to start of today
            
            const futureDates = [];
            const pastDates = [];
            
            sortedDates.forEach(dateString => {
                const dateParts = dateString.split('-');
                const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); // Months are 0-indexed
                if (date >= today) {
                    futureDates.push(dateString);
                } else {
                    pastDates.push(dateString);
                }
            });
            
            console.log(`Found ${futureDates.length} future dates and ${pastDates.length} past dates`);
            
            // If there are past dates, add a button to show them at the top
            if (pastDates.length > 0) {
                const showPastButton = document.createElement('button');
                showPastButton.className = 'past-dates-button';
                showPastButton.textContent = 'Prikaži prethodni raspored';
                showPastButton.addEventListener('click', function() {
                    document.body.classList.toggle('show-past-dates');
                    this.textContent = document.body.classList.contains('show-past-dates') 
                        ? 'Sakrij prethodni raspored' 
                        : 'Prikaži prethodni raspored';
                });
                container.appendChild(showPastButton);
            }
            
            // Function to create date section - reused for both future and past dates
            function createDateSection(date, isPastDate = false) {
                const sessions = sessionsByDate[date];
                const isNonWorking = sessions.some(s => s.isNeradniDan);
                
                // Get day name from the first session
                const dayName = sessions.length > 0 ? sessions[0].dan : '';
                
                // Create date heading
                const heading = document.createElement('h2');
                heading.className = isPastDate ? 'date-heading past-date-heading' : 'date-heading';
                
                // Convert ISO date to Croatian format
                const croatianDate = isoToCroatianDate(date);
                
                heading.innerHTML = `${croatianDate} <span class="day-name">${dayName}</span>`;
                container.appendChild(heading);
                
                // Create entries container
                const entriesDiv = document.createElement('div');
                entriesDiv.className = isPastDate ? 'schedule-entries past-schedule-entries' : 'schedule-entries';
                
                if (isNonWorking) {
                    // Non-working day
                    const entry = document.createElement('div');
                    entry.className = 'schedule-entry non-working-date';
                    entry.innerHTML = '<div class="schedule-entry-time"></div><div class="schedule-entry-location">Neradni dan</div>';
                    entriesDiv.appendChild(entry);
                } else {
                    // Sort sessions by time
                    sessions.sort((a, b) => a.vrijeme.localeCompare(b.vrijeme));
                    
                    // Add each session
                    sessions.forEach(session => {
                        const entry = document.createElement('div');
                        entry.className = 'schedule-entry';
                        
                        // Create time element
                        const timeDiv = document.createElement('div');
                        timeDiv.className = 'schedule-entry-time';
                        
                        // Handle raw HTML in time field
                        if (session.vrijeme.includes('<') && session.vrijeme.includes('>')) {
                            // Extract text content from HTML 
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = session.vrijeme;
                            timeDiv.textContent = tempDiv.textContent.trim();
                        } else {
                            timeDiv.textContent = session.vrijeme;
                        }
                        
                        // Create location element with possible link
                        const locationDiv = document.createElement('div');
                        locationDiv.className = 'schedule-entry-location';
                        
                        // Get clean location text
                        let locationText = session.lokacija;
                        if (locationText.includes('<') && locationText.includes('>')) {
                            // Extract text content from HTML
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = locationText;
                            locationText = tempDiv.textContent.trim();
                        }
                        
                        if (session.mapUrl) {
                            const link = document.createElement('a');
                            link.href = session.mapUrl;
                            link.className = 'location-link';
                            link.textContent = locationText;
                            link.target = '_blank';
                            link.title = session.address || locationText;
                            locationDiv.appendChild(link);
                        } else {
                            locationDiv.textContent = locationText;
                        }
                        
                        // Add time and location to entry
                        entry.appendChild(timeDiv);
                        entry.appendChild(locationDiv);
                        
                        // Add entry to container
                        entriesDiv.appendChild(entry);
                    });
                }
                
                container.appendChild(entriesDiv);
            }
            
            // First display future dates
            futureDates.forEach(date => createDateSection(date, false));
            
            // Add past dates (initially hidden)
            if (pastDates.length > 0) {
                pastDates.forEach(date => createDateSection(date, true));
            }
            
            // If no entries or only past dates, show appropriate message
            if (sortedDates.length === 0) {
                const noData = document.createElement('p');
                noData.className = 'no-data-message';
                noData.textContent = 'Nema podataka za odabranu lokaciju.';
                container.appendChild(noData);
            } else if (futureDates.length === 0 && pastDates.length > 0) {
                const noFutureData = document.createElement('p');
                noFutureData.className = 'no-data-message';
                noFutureData.textContent = 'Nema budućih datuma za odabranu lokaciju.';
                // Insert this message before the past dates button
                container.insertBefore(noFutureData, container.querySelector('.past-dates-button'));
            }
        }
        
        // Filter functionality based on location
        function filterScheduleByLocation(locationId) {
            // Generate the list view with the new filter
            generateListView();
        }
        
        // Tab switching
        document.querySelectorAll('.data-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding view
                document.querySelectorAll('.data-view').forEach(view => view.classList.remove('active'));
                document.getElementById(tab.dataset.tab + '-view').classList.add('active');
                
                // If switching to calendar, initialize it
                if (tab.dataset.tab === 'calendar') {
                    initCalendar();
                }
            });
        });
        
        // Calendar functionality
        let currentDate = new Date();
        let calendarInitialized = false;
        
        function initCalendar() {
            if (!calendarInitialized) {
                renderCalendar(currentDate);
                
                document.getElementById('prev-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar(currentDate);
                });
                
                document.getElementById('next-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar(currentDate);
                });
                
                calendarInitialized = true;
            }
        }
        
        function renderCalendar(date) {
            const monthNames = ['Siječanj', 'Veljača', 'Ožujak', 'Travanj', 'Svibanj', 'Lipanj', 
                               'Srpanj', 'Kolovoz', 'Rujan', 'Listopad', 'Studeni', 'Prosinac'];
            
            const year = date.getFullYear();
            const month = date.getMonth();
            const activeTab = document.querySelector('.location-tab.active');
            const locationFilter = activeTab ? activeTab.dataset.locationId : '';
            
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let calendarHTML = '<div class="calendar">';
            calendarHTML += '<div class="calendar-header">';
            calendarHTML += '<div>Pon</div><div>Uto</div><div>Sri</div><div>Čet</div><div>Pet</div><div>Sub</div><div>Ned</div>';
            calendarHTML += '</div>';
            calendarHTML += '<div class="calendar-body">';
            
            // Fill in leading empty cells
            let dayOfWeek = firstDay.getDay() || 7; // Convert Sunday (0) to 7
            for (let i = 1; i < dayOfWeek; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }
            
            // Fill in days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDay = new Date(year, month, day);
                const isoDateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const croatianDateString = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}.`;
                
                // Check if this day is in the past
                const calendarDate = new Date(year, month, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isPastDate = calendarDate < today;
                
                // Find schedule entries for this day, filtered by selected location if any
                let dayEntries = scheduleData.filter(entry => entry.datum === isoDateString);
                
                // Apply location filter if set
                if (locationFilter) {
                    // Debug the filtering process
                    console.log('Filtering by location ID:', locationFilter);
                    console.log('Before filter, entries:', dayEntries.length);
                    
                    dayEntries = dayEntries.filter(entry => {
                        const matches = entry.locationId === locationFilter || entry.isNeradniDan;
                        console.log(`Entry locationId: ${entry.locationId}, matches filter: ${matches}`);
                        return matches;
                    });
                    
                    console.log('After filter, entries:', dayEntries.length);
                }
                
                let dayClass = 'calendar-day';
                if (dayEntries.length > 0) {
                    dayClass += ' has-events';
                }
                if (isPastDate) {
                    dayClass += ' past-date';
                }
                
                calendarHTML += `<div class="${dayClass}" data-date="${croatianDateString}">`;
                calendarHTML += `<div class="day-number">${day}</div>`;
                
                if (dayEntries.length > 0) {
                    calendarHTML += '<div class="day-events">';
                    
                    // Group entries by location for this day
                    const entriesByLocation = {};
                    dayEntries.forEach(entry => {
                        if (!entriesByLocation[entry.lokacija]) {
                            entriesByLocation[entry.lokacija] = [];
                        }
                        entriesByLocation[entry.lokacija].push(entry);
                    });
                    
                    // Display all locations directly, always visible
                    const locations = Object.keys(entriesByLocation).sort();
                    
                    // For non-working days, display specially
                    if (locations.includes("=== neradni dan ===")) {
                        calendarHTML += `<div class="calendar-location non-working-day">=== neradni dan ===</div>`;
                    } else {
                        // Create a sorted list of entries by start time
                        let allEntries = [];
                        
                        console.log(`Day has ${locations.length} locations:`, locations);
                        
                        locations.forEach(location => {
                            console.log(`Processing location: ${location}, has ${entriesByLocation[location].length} entries`);
                            
                            entriesByLocation[location].forEach(entry => {
                                // Extract the start time from the time range
                                let startTime = "";
                                if (entry.vrijeme && entry.vrijeme.includes('-')) {
                                    startTime = entry.vrijeme.split('-')[0].trim();
                                } else if (entry.vrijeme) {
                                    startTime = entry.vrijeme;
                                }
                                
                                console.log(`Entry time: ${entry.vrijeme}, start time: ${startTime}, location: ${entry.lokacija}`);
                                
                                if (startTime) {
                                    allEntries.push({
                                        startTime: startTime,
                                        location: entry.lokacija,
                                        fullTime: entry.vrijeme
                                    });
                                }
                            });
                        });
                        
                        // Sort entries by start time
                        allEntries.sort((a, b) => {
                            if (a.startTime < b.startTime) return -1;
                            if (a.startTime > b.startTime) return 1;
                            return 0;
                        });
                        
                        // Display all entries in time-first format with map links
                        allEntries.forEach(entry => {
                            // Find the data for this entry to get map URL
                            const sessionData = dayEntries.find(s => 
                                s.lokacija === entry.location && 
                                s.vrijeme && s.vrijeme.startsWith(entry.startTime)
                            );
                            
                            // Generate location name with map link if available
                            let locationHtml = '';
                            if (sessionData && sessionData.mapUrl) {
                                // Make location name itself a link to the map
                                locationHtml = `<a href="${sessionData.mapUrl}" target="_blank" class="location-link" 
                                    title="${sessionData.address || sessionData.lokacija}">
                                    ${entry.location}
                                </a>`;
                            } else {
                                // No map link, just display the location name
                                locationHtml = entry.location;
                            }
                            
                            // Add debug info
                            console.log(`Building entry HTML: time=${entry.startTime}, location="${entry.location}", hasMap=${sessionData && sessionData.mapUrl ? 'true' : 'false'}`);
                            
                            // Create calendar entry with updated structure for full location name display
                            calendarHTML += `<div class="calendar-location">
                                <div class="location-entry-container">
                                    <span class="location-time" style="font-weight:bold; color:#0066cc;">${entry.startTime}</span>
                                    <span class="location-name" style="flex-grow:1; color:#555; display:inline-block; white-space:normal; overflow:visible; word-break:break-word;">${locationHtml}</span>
                                </div>
                            </div>`;
                        });
                    }
                    
                    calendarHTML += '</div>'; // Close day-events
                }
                
                calendarHTML += '</div>';
                
                // Start a new row when reaching Sunday
                if ((dayOfWeek + day - 1) % 7 === 0) {
                    calendarHTML += '</div><div class="calendar-body">';
                }
            }
            
            // Fill in trailing empty cells
            const remainingCells = 7 - (lastDay.getDay() || 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    calendarHTML += '<div class="calendar-day empty"></div>';
                }
            }
            
            calendarHTML += '</div></div>';
            
            document.getElementById('calendar-container').innerHTML = calendarHTML;
            
            // No toggle button in calendar view, but we'll keep the dimmed effect on past dates
            // The calendar will reflect the show-past-dates state from the list view
            
            // No longer adding click events to days with events - we keep users in calendar view
            document.querySelectorAll('.calendar-day.has-events').forEach(day => {
                // Make the day look clickable but don't add navigation behavior
                day.title = "Kliknite za detaljne informacije";
                day.style.cursor = "pointer";
                
                // Optional: You could add a click handler that expands the day's events if you want
                // day.addEventListener('click', () => {
                //     // Expand day events or show more details if needed in the future
                // });
            });
            
            // Debug: Examine the rendered calendar entries
            setTimeout(() => {
                console.log('Examining rendered calendar entries:');
                document.querySelectorAll('.calendar-location').forEach((el, idx) => {
                    console.log(`Entry ${idx}:`, el.innerHTML);
                    
                    // Check location-name specifically
                    const locationName = el.querySelector('.location-name');
                    if (locationName) {
                        console.log(`  Location name: "${locationName.textContent}"`);
                        console.log(`  Location name style:`, window.getComputedStyle(locationName));
                        console.log(`  Location name visibility:`, locationName.offsetWidth > 0 && locationName.offsetHeight > 0);
                    } else {
                        console.log('  No location name element found');
                    }
                    
                    // Check location-map
                    const locationMap = el.querySelector('.location-map');
                    if (locationMap) {
                        console.log(`  Location map present`);
                        console.log(`  Location map style:`, window.getComputedStyle(locationMap));
                    } else {
                        console.log('  No location map element found');
                    }
                });
            }, 1000);
        }
        
        // Function to update the Add to Calendar Button widget
        function updateAddToCalendarWidget(locationName, isAllLocations, calendarFile) {
            const widgetContainer = document.getElementById('add-to-calendar-widget');
            if (!widgetContainer) return;
            
            // Clear previous widget
            widgetContainer.innerHTML = '';
            
            // Get the current date in ISO format for the widget start date
            const today = new Date();
            const startDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Create a date 3 months from now for end date
            const endDate = new Date(today);
            endDate.setMonth(today.getMonth() + 3);
            const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
            
            // Using a simplified approach using direct initialization 
            // with the global atcb_action function
            
            // Set widget properties
            const widgetTitle = isAllLocations ? 'Zagreb Bibliobus - Raspored' : `Zagreb Bibliobus - ${locationName}`;
            const widgetDescription = isAllLocations 
                ? 'Raspored bibliobusnih stajališta u Zagrebu' 
                : `Raspored bibliobusa za lokaciju ${locationName}`;
                
            // Use absolute URL for iCal file (assume we're on the same domain)
            const host = window.location.origin;
            const calPath = calendarFile || 'bibliobus-calendar.ics';
            
            // Create calendar button with simpler configuration
            const buttonElement = document.createElement('button');
            buttonElement.className = 'calendar-add-button';
            buttonElement.textContent = 'Dodaj u kalendar';
            buttonElement.onclick = function() {
                if (typeof atcb_action === 'function') {
                    atcb_action({
                        name: widgetTitle,
                        description: widgetDescription,
                        startDate: startDate,
                        endDate: endDateStr,
                        options: ['Apple', 'Google', 'iCal', 'Microsoft365', 'Outlook.com', 'Yahoo'],
                        timeZone: 'Europe/Zagreb',
                        iCalFileName: calPath.split('/').pop(),
                        listStyle: 'dropdown',
                        trigger: 'click',
                        buttonStyle: 'round',
                        language: 'hr',
                        ical: `${host}/${calPath}`
                    });
                } else {
                    alert('Kalendarska komponenta nije učitana. Molimo koristite iCalendar datoteku.');
                }
                return false;
            };
            
            // Append to container
            widgetContainer.appendChild(buttonElement);
        }
        
        // Initialize views when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Generate list view immediately
            generateListView();
            
            // Auto-initialize calendar if that tab is active
            if (document.querySelector('.data-tab[data-tab="calendar"]').classList.contains('active')) {
                initCalendar();
            }
            
            // Initialize the Add to Calendar widget
            const activeTab = document.querySelector('.location-tab.active');
            const locationName = activeTab ? activeTab.textContent : 'Sve lokacije';
            const isAllLocations = !activeTab || activeTab.dataset.locationId === '';
            const calendarFile = activeTab ? activeTab.dataset.calendarFile : 'bibliobus-calendar.ics';
            
            // Let the page load first, then initialize the widget
            setTimeout(() => {
                updateAddToCalendarWidget(locationName, isAllLocations, calendarFile);
            }, 500);
        });
    </script>
</body>
</html>