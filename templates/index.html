<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zagreb Bibliobus - Raspored</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-bus"></i> Zagreb Bibliobus</h1>
            <p>Raspored bibliobusnih stajališta</p>
            <div class="updated">Ažurirano: {{LAST_UPDATED}}</div>
        </div>
    </header>

    <main class="container">
        <div class="search-container">
            <input type="text" id="search" placeholder="Pretraži po lokaciji ili datumu...">
            <select id="filter-day">
                <option value="">Svi dani</option>
                <option value="PONEDJELJAK">Ponedjeljak</option>
                <option value="UTORAK">Utorak</option>
                <option value="SRIJEDA">Srijeda</option>
                <option value="ČETVRTAK">Četvrtak</option>
                <option value="PETAK">Petak</option>
                <option value="SUBOTA">Subota</option>
                <option value="NEDJELJA">Nedjelja</option>
            </select>
        </div>

        <div class="data-info">
            <div class="data-tab active" data-tab="table">Tablični prikaz</div>
            <div class="data-tab" data-tab="calendar">Kalendarski prikaz</div>
            <div class="data-download">
                <a href="bibliobus-data.json" download><i class="fas fa-download"></i> Preuzmi JSON</a>
                <a href="bibliobus-calendar.ics" download><i class="fas fa-calendar-alt"></i> Preuzmi iCalendar</a>
            </div>
        </div>

        <div id="table-view" class="data-view active">
            <table>
                <thead>
                    <tr>
                        <th>Dan</th>
                        <th>Datum</th>
                        <th>Vrijeme</th>
                        <th>Lokacija</th>
                    </tr>
                </thead>
                <tbody id="schedule-data">
                    <!-- Schedule data will be inserted here -->
                    {{TABLE_DATA}}
                </tbody>
            </table>
        </div>

        <div id="calendar-view" class="data-view">
            <div class="calendar-nav">
                <button id="prev-month">&laquo; Prethodni mjesec</button>
                <h2 id="current-month">Travanj 2025</h2>
                <button id="next-month">Sljedeći mjesec &raquo;</button>
            </div>
            <div class="calendar-info">
                <p>Za dodavanje u Google Calendar ili drugi kalendar, preuzmite <a href="bibliobus-calendar.ics" download>iCalendar datoteku</a>, 
                a zatim je uvezite u vašu aplikaciju za kalendar.</p>
            </div>
            <div id="calendar-container">
                <!-- Calendar will be rendered here -->
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Zagreb Bibliobus - Generirano pomoću <a href="https://github.com/allixsenos/ZgBibliobusTimeTable">ZgBibliobusTimeTable</a></p>
        </div>
    </footer>

    <script>
        // Data loaded from JSON file
        const scheduleData = {{JSON_DATA}};
        
        // Function to convert ISO date (yyyy-MM-dd) to Croatian date (dd.MM.yyyy.)
        function isoToCroatianDate(isoDate) {
            if (!isoDate) return '';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            return `${parts[2]}.${parts[1]}.${parts[0]}.`;
        }
        
        // Function to convert Croatian date (dd.MM.yyyy.) to ISO date (yyyy-MM-dd)
        function croatianToIsoDate(croatianDate) {
            if (!croatianDate) return '';
            // Remove trailing dot if present
            const cleanDate = croatianDate.endsWith('.') ? croatianDate.slice(0, -1) : croatianDate;
            const parts = cleanDate.split('.');
            if (parts.length < 3) return croatianDate;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        // Search functionality
        document.getElementById('search').addEventListener('input', filterSchedule);
        document.getElementById('filter-day').addEventListener('change', filterSchedule);
        
        function filterSchedule() {
            const searchText = document.getElementById('search').value.toLowerCase();
            const dayFilter = document.getElementById('filter-day').value;
            const rows = document.getElementById('schedule-data').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const day = rows[i].cells[0].textContent;
                const date = rows[i].cells[1].textContent;
                const time = rows[i].cells[2].textContent;
                const location = rows[i].cells[3].textContent;
                
                const matchesSearch = 
                    day.toLowerCase().includes(searchText) ||
                    date.toLowerCase().includes(searchText) ||
                    time.toLowerCase().includes(searchText) ||
                    location.toLowerCase().includes(searchText);
                
                const matchesDay = dayFilter === '' || day.trim() === dayFilter;
                
                rows[i].style.display = (matchesSearch && matchesDay) ? '' : 'none';
            }
        }
        
        // Tab switching
        document.querySelectorAll('.data-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding view
                document.querySelectorAll('.data-view').forEach(view => view.classList.remove('active'));
                document.getElementById(tab.dataset.tab + '-view').classList.add('active');
                
                // If switching to calendar, initialize it
                if (tab.dataset.tab === 'calendar') {
                    initCalendar();
                }
            });
        });
        
        // Calendar functionality
        let currentDate = new Date();
        let calendarInitialized = false;
        
        function initCalendar() {
            if (!calendarInitialized) {
                renderCalendar(currentDate);
                
                document.getElementById('prev-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar(currentDate);
                });
                
                document.getElementById('next-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar(currentDate);
                });
                
                calendarInitialized = true;
            }
        }
        
        function renderCalendar(date) {
            const monthNames = ['Siječanj', 'Veljača', 'Ožujak', 'Travanj', 'Svibanj', 'Lipanj', 
                               'Srpanj', 'Kolovoz', 'Rujan', 'Listopad', 'Studeni', 'Prosinac'];
            
            const year = date.getFullYear();
            const month = date.getMonth();
            
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let calendarHTML = '<div class="calendar">';
            calendarHTML += '<div class="calendar-header">';
            calendarHTML += '<div>Pon</div><div>Uto</div><div>Sri</div><div>Čet</div><div>Pet</div><div>Sub</div><div>Ned</div>';
            calendarHTML += '</div>';
            calendarHTML += '<div class="calendar-body">';
            
            // Fill in leading empty cells
            let dayOfWeek = firstDay.getDay() || 7; // Convert Sunday (0) to 7
            for (let i = 1; i < dayOfWeek; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }
            
            // Fill in days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDay = new Date(year, month, day);
                const isoDateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const croatianDateString = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}.`;
                
                // Find schedule entries for this day
                const dayEntries = scheduleData.filter(entry => entry.datum === isoDateString);
                
                let dayClass = 'calendar-day';
                if (dayEntries.length > 0) {
                    dayClass += ' has-events';
                }
                
                calendarHTML += `<div class="${dayClass}" data-date="${croatianDateString}">`;
                calendarHTML += `<div class="day-number">${day}</div>`;
                
                if (dayEntries.length > 0) {
                    calendarHTML += '<div class="day-events">';
                    
                    // Group entries by location for this day
                    const entriesByLocation = {};
                    dayEntries.forEach(entry => {
                        if (!entriesByLocation[entry.lokacija]) {
                            entriesByLocation[entry.lokacija] = [];
                        }
                        entriesByLocation[entry.lokacija].push(entry);
                    });
                    
                    // Display all locations directly, always visible
                    const locations = Object.keys(entriesByLocation).sort();
                    
                    // For non-working days, display specially
                    if (locations.includes("=== neradni dan ===")) {
                        calendarHTML += `<div class="calendar-location non-working-day">=== neradni dan ===</div>`;
                    } else {
                        // Create a sorted list of entries by start time
                        let allEntries = [];
                        
                        locations.forEach(location => {
                            entriesByLocation[location].forEach(entry => {
                                // Extract the start time from the time range
                                let startTime = "";
                                if (entry.vrijeme && entry.vrijeme.includes('-')) {
                                    startTime = entry.vrijeme.split('-')[0].trim();
                                } else if (entry.vrijeme) {
                                    startTime = entry.vrijeme;
                                }
                                
                                if (startTime) {
                                    allEntries.push({
                                        startTime: startTime,
                                        location: entry.lokacija,
                                        fullTime: entry.vrijeme
                                    });
                                }
                            });
                        });
                        
                        // Sort entries by start time
                        allEntries.sort((a, b) => {
                            if (a.startTime < b.startTime) return -1;
                            if (a.startTime > b.startTime) return 1;
                            return 0;
                        });
                        
                        // Display all entries in time-first format
                        allEntries.forEach(entry => {
                            calendarHTML += `<div class="calendar-location">
                                <span class="location-entry">${entry.startTime} ${entry.location}</span>
                            </div>`;
                        });
                    }
                    
                    calendarHTML += '</div>'; // Close day-events
                }
                
                calendarHTML += '</div>';
                
                // Start a new row when reaching Sunday
                if ((dayOfWeek + day - 1) % 7 === 0) {
                    calendarHTML += '</div><div class="calendar-body">';
                }
            }
            
            // Fill in trailing empty cells
            const remainingCells = 7 - (lastDay.getDay() || 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    calendarHTML += '<div class="calendar-day empty"></div>';
                }
            }
            
            calendarHTML += '</div></div>';
            
            document.getElementById('calendar-container').innerHTML = calendarHTML;
            
            // Add click event to days with events
            document.querySelectorAll('.calendar-day.has-events').forEach(day => {
                day.addEventListener('click', () => {
                    const date = day.dataset.date;
                    document.getElementById('search').value = date;
                    document.getElementById('filter-day').value = '';
                    
                    // Switch to table view
                    document.querySelector('.data-tab[data-tab="table"]').click();
                    
                    filterSchedule();
                });
            });
        }
        
        // Initialize the calendar view when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-initialize calendar if that tab is active
            if (document.querySelector('.data-tab[data-tab="calendar"]').classList.contains('active')) {
                initCalendar();
            }
        });
    </script>
</body>
</html>