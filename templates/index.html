<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zagreb Bibliobus - Raspored</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-bus"></i> Zagreb Bibliobus</h1>
            <p>Raspored bibliobusnih stajališta</p>
            <div class="updated">Ažurirano: {{LAST_UPDATED}}</div>
        </div>
    </header>

    <main class="container">
        <div class="navigation-container">
            <div class="data-views">
                <div class="data-tab active" data-tab="table">Tablični prikaz</div>
                <div class="data-tab" data-tab="calendar">Kalendarski prikaz</div>
            </div>
            
            <div class="location-tabs-wrapper">
                <div class="location-tabs" id="location-tabs">
                    <div class="location-tab active" data-location-id="">Sve lokacije</div>
                    <!-- Location tabs will be populated from JSON data -->
                </div>
                <div class="location-tabs-scroll">
                    <button class="scroll-btn scroll-left" aria-label="Scroll left"><i class="fas fa-chevron-left"></i></button>
                    <button class="scroll-btn scroll-right" aria-label="Scroll right"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
            
            <div class="data-download">
                <a href="bibliobus-data.json" download><i class="fas fa-download"></i> Preuzmi JSON</a>
                <a id="calendar-download" href="bibliobus-calendar.ics" download>
                    <i class="fas fa-calendar-alt"></i> <span id="calendar-download-text">Preuzmi iCalendar (sve lokacije)</span>
                </a>
            </div>
        </div>

        <div id="table-view" class="data-view active">
            <table>
                <thead>
                    <tr>
                        <th>Dan</th>
                        <th>Datum</th>
                        <th>Vrijeme</th>
                        <th>Lokacija</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="schedule-data">
                    <!-- Schedule data will be inserted here -->
                    {{TABLE_DATA}}
                </tbody>
            </table>
        </div>

        <div id="calendar-view" class="data-view">
            <div class="calendar-nav">
                <button id="prev-month">&laquo; Prethodni mjesec</button>
                <h2 id="current-month">Travanj 2025</h2>
                <button id="next-month">Sljedeći mjesec &raquo;</button>
            </div>
            <div class="calendar-info">
                <p>Za dodavanje u Google Calendar ili drugi kalendar, preuzmite <a id="calendar-info-link" href="bibliobus-calendar.ics" download>iCalendar datoteku</a>, 
                a zatim je uvezite u vašu aplikaciju za kalendar.</p>
                <p class="location-specific-note"><strong>Važno:</strong> Kada odaberete lokaciju iznad (npr. "KAJZERICA"), 
                gumb za preuzimanje kalendara će automatski preuzeti iCalendar <strong>samo za odabranu lokaciju</strong>.</p>
            </div>
            <div id="calendar-container">
                <!-- Calendar will be rendered here -->
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Zagreb Bibliobus - Generirano pomoću <a href="https://github.com/allixsenos/ZgBibliobusTimeTable">ZgBibliobusTimeTable</a></p>
        </div>
    </footer>

    <script>
        // Data loaded from JSON file
        const data = {{JSON_DATA}};
        const scheduleData = data.sessions;
        const locationOptions = data.locations;
        
        // Function to convert ISO date (yyyy-MM-dd) to Croatian date (dd.MM.yyyy.)
        function isoToCroatianDate(isoDate) {
            if (!isoDate) return '';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            return `${parts[2]}.${parts[1]}.${parts[0]}.`;
        }
        
        // Function to convert Croatian date (dd.MM.yyyy.) to ISO date (yyyy-MM-dd)
        function croatianToIsoDate(croatianDate) {
            if (!croatianDate) return '';
            // Remove trailing dot if present
            const cleanDate = croatianDate.endsWith('.') ? croatianDate.slice(0, -1) : croatianDate;
            const parts = cleanDate.split('.');
            if (parts.length < 3) return croatianDate;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        // Initialize location tabs
        const locationTabsContainer = document.getElementById('location-tabs');
        
        // Debug location options
        console.log("All location options:", locationOptions);
        
        // Add location options to the tabs (first one "Sve lokacije" is already there)
        locationOptions.slice(1).forEach(location => {
            const tab = document.createElement('div');
            tab.className = 'location-tab';
            tab.textContent = location.name;
            tab.dataset.locationId = location.value;
            tab.dataset.calendarFile = location.calendarFile;
            locationTabsContainer.appendChild(tab);
            
            console.log(`Added location tab: name=${location.name}, id=${location.value}, calendar=${location.calendarFile}`);
        });
        
        // Make sure the "All locations" tab has the correct data attributes
        const allLocationsTab = locationTabsContainer.querySelector('.location-tab.active');
        allLocationsTab.dataset.calendarFile = "bibliobus-calendar.ics";
        
        // Add click events to location tabs
        document.querySelectorAll('.location-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Update active tab
                document.querySelectorAll('.location-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const locationId = tab.dataset.locationId;
                const calendarFile = tab.dataset.calendarFile;
                const locationName = tab.textContent;
                const isAllLocations = locationId === '';
                
                console.log(`Selected location: name=${locationName}, id=${locationId}, isAllLocations=${isAllLocations}`);
                
                // Update download links
                document.getElementById('calendar-download').href = calendarFile;
                document.getElementById('calendar-info-link').href = calendarFile;
                
                // Update download text
                const downloadTextElement = document.getElementById('calendar-download-text');
                if (isAllLocations) {
                    downloadTextElement.textContent = 'Preuzmi iCalendar (sve lokacije)';
                } else {
                    downloadTextElement.textContent = `Preuzmi iCalendar (${locationName})`;
                }
                
                // Debug the location filter and session data
                console.log(`Filtering data by location ID: ${locationId}`);
                console.log(`Data contains ${scheduleData.length} total sessions`);
                
                // Sample session data to check structure
                if (scheduleData.length > 0) {
                    console.log('Sample session data:', scheduleData[0]);
                    
                    // Check all available locationId values in the data
                    const allLocationIds = [...new Set(scheduleData.map(s => s.locationId))];
                    console.log('All location IDs in data:', allLocationIds);
                }
                
                // Update calendar and table views
                filterScheduleByLocation(locationId);
                if (calendarInitialized) {
                    renderCalendar(currentDate);
                }
            });
        });
        
        // Add horizontal scrolling for location tabs
        const tabsContainer = document.querySelector('.location-tabs');
        const scrollLeftBtn = document.querySelector('.scroll-left');
        const scrollRightBtn = document.querySelector('.scroll-right');
        
        scrollLeftBtn.addEventListener('click', () => {
            tabsContainer.scrollBy({ left: -200, behavior: 'smooth' });
        });
        
        scrollRightBtn.addEventListener('click', () => {
            tabsContainer.scrollBy({ left: 200, behavior: 'smooth' });
        });
        
        // Check if scrolling is needed and show/hide scroll buttons accordingly
        function updateScrollButtons() {
            const hasHorizontalScroll = tabsContainer.scrollWidth > tabsContainer.clientWidth;
            const scrollContainer = document.querySelector('.location-tabs-scroll');
            scrollContainer.style.display = hasHorizontalScroll ? 'flex' : 'none';
        }
        
        // Update on load and on window resize
        window.addEventListener('load', updateScrollButtons);
        window.addEventListener('resize', updateScrollButtons);
        
        // Filter functionality based on location
        function filterScheduleByLocation(locationId) {
            const rows = document.getElementById('schedule-data').getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const location = rows[i].cells[3].textContent;
                const rowLocationId = rows[i].dataset.locationId || '';
                
                // Show all rows if no location filter, or if location matches, or if it's a non-working day
                const matchesLocation = locationId === '' || 
                    rowLocationId === locationId || 
                    (locationId === '' && location.includes("neradni dan"));
                
                rows[i].style.display = matchesLocation ? '' : 'none';
            }
        }
        
        // Add location ID data attributes to table rows
        document.querySelectorAll('#schedule-data tr').forEach(row => {
            const locationCell = row.cells[3];
            if (locationCell) {
                const locationName = locationCell.textContent;
                const isNonWorkingDay = locationName.includes("neradni dan");
                
                if (!isNonWorkingDay) {
                    const location = locationOptions.find(loc => loc.name === locationName);
                    if (location) {
                        row.dataset.locationId = location.value;
                    }
                }
            }
        });
        
        // Tab switching
        document.querySelectorAll('.data-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.data-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding view
                document.querySelectorAll('.data-view').forEach(view => view.classList.remove('active'));
                document.getElementById(tab.dataset.tab + '-view').classList.add('active');
                
                // If switching to calendar, initialize it
                if (tab.dataset.tab === 'calendar') {
                    initCalendar();
                }
            });
        });
        
        // Calendar functionality
        let currentDate = new Date();
        let calendarInitialized = false;
        
        function initCalendar() {
            if (!calendarInitialized) {
                renderCalendar(currentDate);
                
                document.getElementById('prev-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar(currentDate);
                });
                
                document.getElementById('next-month').addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar(currentDate);
                });
                
                calendarInitialized = true;
            }
        }
        
        function renderCalendar(date) {
            const monthNames = ['Siječanj', 'Veljača', 'Ožujak', 'Travanj', 'Svibanj', 'Lipanj', 
                               'Srpanj', 'Kolovoz', 'Rujan', 'Listopad', 'Studeni', 'Prosinac'];
            
            const year = date.getFullYear();
            const month = date.getMonth();
            const activeTab = document.querySelector('.location-tab.active');
            const locationFilter = activeTab ? activeTab.dataset.locationId : '';
            
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let calendarHTML = '<div class="calendar">';
            calendarHTML += '<div class="calendar-header">';
            calendarHTML += '<div>Pon</div><div>Uto</div><div>Sri</div><div>Čet</div><div>Pet</div><div>Sub</div><div>Ned</div>';
            calendarHTML += '</div>';
            calendarHTML += '<div class="calendar-body">';
            
            // Fill in leading empty cells
            let dayOfWeek = firstDay.getDay() || 7; // Convert Sunday (0) to 7
            for (let i = 1; i < dayOfWeek; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }
            
            // Fill in days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDay = new Date(year, month, day);
                const isoDateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const croatianDateString = `${String(day).padStart(2, '0')}.${String(month + 1).padStart(2, '0')}.${year}.`;
                
                // Find schedule entries for this day, filtered by selected location if any
                let dayEntries = scheduleData.filter(entry => entry.datum === isoDateString);
                
                // Apply location filter if set
                if (locationFilter) {
                    // Debug the filtering process
                    console.log('Filtering by location ID:', locationFilter);
                    console.log('Before filter, entries:', dayEntries.length);
                    
                    dayEntries = dayEntries.filter(entry => {
                        const matches = entry.locationId === locationFilter || entry.isNeradniDan;
                        console.log(`Entry locationId: ${entry.locationId}, matches filter: ${matches}`);
                        return matches;
                    });
                    
                    console.log('After filter, entries:', dayEntries.length);
                }
                
                let dayClass = 'calendar-day';
                if (dayEntries.length > 0) {
                    dayClass += ' has-events';
                }
                
                calendarHTML += `<div class="${dayClass}" data-date="${croatianDateString}">`;
                calendarHTML += `<div class="day-number">${day}</div>`;
                
                if (dayEntries.length > 0) {
                    calendarHTML += '<div class="day-events">';
                    
                    // Group entries by location for this day
                    const entriesByLocation = {};
                    dayEntries.forEach(entry => {
                        if (!entriesByLocation[entry.lokacija]) {
                            entriesByLocation[entry.lokacija] = [];
                        }
                        entriesByLocation[entry.lokacija].push(entry);
                    });
                    
                    // Display all locations directly, always visible
                    const locations = Object.keys(entriesByLocation).sort();
                    
                    // For non-working days, display specially
                    if (locations.includes("=== neradni dan ===")) {
                        calendarHTML += `<div class="calendar-location non-working-day">=== neradni dan ===</div>`;
                    } else {
                        // Create a sorted list of entries by start time
                        let allEntries = [];
                        
                        console.log(`Day has ${locations.length} locations:`, locations);
                        
                        locations.forEach(location => {
                            console.log(`Processing location: ${location}, has ${entriesByLocation[location].length} entries`);
                            
                            entriesByLocation[location].forEach(entry => {
                                // Extract the start time from the time range
                                let startTime = "";
                                if (entry.vrijeme && entry.vrijeme.includes('-')) {
                                    startTime = entry.vrijeme.split('-')[0].trim();
                                } else if (entry.vrijeme) {
                                    startTime = entry.vrijeme;
                                }
                                
                                console.log(`Entry time: ${entry.vrijeme}, start time: ${startTime}, location: ${entry.lokacija}`);
                                
                                if (startTime) {
                                    allEntries.push({
                                        startTime: startTime,
                                        location: entry.lokacija,
                                        fullTime: entry.vrijeme
                                    });
                                }
                            });
                        });
                        
                        // Sort entries by start time
                        allEntries.sort((a, b) => {
                            if (a.startTime < b.startTime) return -1;
                            if (a.startTime > b.startTime) return 1;
                            return 0;
                        });
                        
                        // Display all entries in time-first format with map links
                        allEntries.forEach(entry => {
                            // Find the data for this entry to get map URL
                            const sessionData = dayEntries.find(s => 
                                s.lokacija === entry.location && 
                                s.vrijeme && s.vrijeme.startsWith(entry.startTime)
                            );
                            
                            // Generate location name with map link if available
                            let locationHtml = '';
                            if (sessionData && sessionData.mapUrl) {
                                // Make location name itself a link to the map
                                locationHtml = `<a href="${sessionData.mapUrl}" target="_blank" class="location-link" 
                                    title="${sessionData.address || sessionData.lokacija}">
                                    ${entry.location}
                                </a>`;
                            } else {
                                // No map link, just display the location name
                                locationHtml = entry.location;
                            }
                            
                            // Add debug info
                            console.log(`Building entry HTML: time=${entry.startTime}, location="${entry.location}", hasMap=${sessionData && sessionData.mapUrl ? 'true' : 'false'}`);
                            
                            // Create calendar entry with updated structure for full location name display
                            calendarHTML += `<div class="calendar-location">
                                <div class="location-entry-container">
                                    <span class="location-time" style="font-weight:bold; color:#0066cc;">${entry.startTime}</span>
                                    <span class="location-name" style="flex-grow:1; color:#555; display:inline-block; white-space:normal; overflow:visible; word-break:break-word;">${locationHtml}</span>
                                </div>
                            </div>`;
                        });
                    }
                    
                    calendarHTML += '</div>'; // Close day-events
                }
                
                calendarHTML += '</div>';
                
                // Start a new row when reaching Sunday
                if ((dayOfWeek + day - 1) % 7 === 0) {
                    calendarHTML += '</div><div class="calendar-body">';
                }
            }
            
            // Fill in trailing empty cells
            const remainingCells = 7 - (lastDay.getDay() || 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    calendarHTML += '<div class="calendar-day empty"></div>';
                }
            }
            
            calendarHTML += '</div></div>';
            
            document.getElementById('calendar-container').innerHTML = calendarHTML;
            
            // Add click event to days with events
            document.querySelectorAll('.calendar-day.has-events').forEach(day => {
                day.addEventListener('click', () => {
                    const date = day.dataset.date;
                    
                    // Switch to table view
                    document.querySelector('.data-tab[data-tab="table"]').click();
                    
                    // Highlight the row with this date by adding a CSS class
                    document.querySelectorAll('#schedule-data tr').forEach(row => {
                        row.classList.remove('highlighted-row');
                        if (row.cells && row.cells[1] && row.cells[1].textContent === date) {
                            row.classList.add('highlighted-row');
                        }
                    });
                });
            });
            
            // Debug: Examine the rendered calendar entries
            setTimeout(() => {
                console.log('Examining rendered calendar entries:');
                document.querySelectorAll('.calendar-location').forEach((el, idx) => {
                    console.log(`Entry ${idx}:`, el.innerHTML);
                    
                    // Check location-name specifically
                    const locationName = el.querySelector('.location-name');
                    if (locationName) {
                        console.log(`  Location name: "${locationName.textContent}"`);
                        console.log(`  Location name style:`, window.getComputedStyle(locationName));
                        console.log(`  Location name visibility:`, locationName.offsetWidth > 0 && locationName.offsetHeight > 0);
                    } else {
                        console.log('  No location name element found');
                    }
                    
                    // Check location-map
                    const locationMap = el.querySelector('.location-map');
                    if (locationMap) {
                        console.log(`  Location map present`);
                        console.log(`  Location map style:`, window.getComputedStyle(locationMap));
                    } else {
                        console.log('  No location map element found');
                    }
                });
            }, 1000);
        }
        
        // Initialize the calendar view when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-initialize calendar if that tab is active
            if (document.querySelector('.data-tab[data-tab="calendar"]').classList.contains('active')) {
                initCalendar();
            }
        });
    </script>
</body>
</html>